@model IEnumerable<ASM1.Repository.Models.Quotation>

@{
    ViewData["Title"] = "Quotation Management";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-file-text text-primary"></i> Quotation Management</h2>
                    <p class="text-muted">Manage customer quotations and approvals</p>
                </div>
                <div>
                    <a asp-action="Customers" class="btn btn-outline-primary me-2">
                        <i class="fas fa-users"></i> Select Customer
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Status Filter</label>
                            <select class="form-select" id="statusFilter" onchange="filterQuotations()">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Search Customer</label>
                            <input type="text" class="form-control" id="customerSearch" placeholder="Search by name or email...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Vehicle Search</label>
                            <input type="text" class="form-control" id="vehicleSearch" placeholder="Search by vehicle name...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="filterQuotations()">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quotations Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Quotation List</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Quote ID</th>
                                    <th>Customer</th>
                                    <th>Vehicle</th>
                                    <th>Price</th>
                                    <th>Created Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var quotation in Model)
                                {
                                    <tr>
                                        <td>
                                            <strong>#Q@(quotation.QuotationId.ToString("000"))</strong>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>@(quotation.Customer?.FullName ?? "N/A")</strong><br>
                                                <small class="text-muted">@(quotation.Customer?.Email ?? "N/A")</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>@(quotation.Variant?.VehicleModel?.Name ?? "N/A")</strong><br>
                                                <small class="text-muted">@(quotation.Variant?.Version ?? "N/A") - @(quotation.Variant?.Color ?? "N/A")</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="h5 text-success">$@quotation.Price.ToString("N0")</span>
                                        </td>
                                        <td>@quotation.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(quotation.Status ?? "Unknown") fs-6">
                                                @(quotation.Status ?? "Unknown")
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                @if (quotation.Status == "Pending")
                                                {
                                                    <button type="button" class="btn btn-sm btn-success" 
                                                            onclick="approveQuotation(@quotation.QuotationId)"
                                                            data-bs-toggle="tooltip" title="Approve Quotation">
                                                        <i class="fas fa-check"></i> Approve
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger" 
                                                            onclick="rejectQuotation(@quotation.QuotationId)"
                                                            data-bs-toggle="tooltip" title="Reject Quotation">
                                                        <i class="fas fa-times"></i> Reject
                                                    </button>
                                                }
                                                else if (quotation.Status == "Approved")
                                                {
                                                    <button type="button" class="btn btn-sm btn-primary" 
                                                            onclick="createOrder(@quotation.QuotationId)"
                                                            data-bs-toggle="tooltip" title="Create Order">
                                                        <i class="fas fa-shopping-cart"></i> Create Order
                                                    </button>
                                                }
                                                <button type="button" class="btn btn-sm btn-outline-info" 
                                                        onclick="viewQuotationDetails(@quotation.QuotationId)"
                                                        data-bs-toggle="tooltip" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quotation Details Modal -->
<div class="modal fade" id="quotationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-text"></i> Quotation Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="quotationDetails">
                <!-- Quotation details will be loaded here -->
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning text-dark",
            "Approved" => "bg-success",
            "Rejected" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}

@section Scripts {
    <script>
        // Initialize tooltips
        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        function approveQuotation(quotationId) {
            if (confirm(`Are you sure you want to approve quotation #Q${quotationId.toString().padStart(3, '0')}?`)) {
                $.post('@Url.Action("ApproveQuotation")', { quotationId: quotationId })
                    .done(function() {
                        showSuccess('Quotation approved successfully!');
                        location.reload();
                    })
                    .fail(function() {
                        showError('Failed to approve quotation. Please try again.');
                    });
            }
        }

        function rejectQuotation(quotationId) {
            if (confirm(`Are you sure you want to reject quotation #Q${quotationId.toString().padStart(3, '0')}?`)) {
                $.post('@Url.Action("RejectQuotation")', { quotationId: quotationId })
                    .done(function(response) {
                        if (response.success) {
                            showSuccess(response.message);
                            location.reload();
                        } else {
                            showError(response.message);
                        }
                    })
                    .fail(function() {
                        showError('Failed to reject quotation. Please try again.');
                    });
            }
        }

        function createOrder(quotationId) {
            if (confirm(`Create order from quotation #Q${quotationId.toString().padStart(3, '0')}?`)) {
                $.post('@Url.Action("CreateOrderFromQuotation")', { quotationId: quotationId })
                    .done(function() {
                        showSuccess('Order created successfully!');
                        window.location.href = '@Url.Action("Orders")';
                    })
                    .fail(function() {
                        showError('Failed to create order. Please try again.');
                    });
            }
        }

        function viewQuotationDetails(quotationId) {
            // Load quotation details in modal
            $('#quotationDetails').html('<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><div class="mt-2">Loading quotation details...</div></div>');
            $('#quotationModal').modal('show');
            
            // Load details from API
            $.get('@Url.Action("GetQuotationDetailsJson")', { quotationId: quotationId })
                .done(function(response) {
                    if (response.success) {
                        const data = response.data;
                        $('#quotationDetails').html(`
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-user"></i> Customer Information</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <p><strong>Name:</strong> ${data.customer.name}</p>
                                            <p><strong>Email:</strong> ${data.customer.email}</p>
                                            <p><strong>Phone:</strong> ${data.customer.phone}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-car"></i> Vehicle Information</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <p><strong>Model:</strong> ${data.vehicle.model}</p>
                                            <p><strong>Version:</strong> ${data.vehicle.version}</p>
                                            <p><strong>Color:</strong> ${data.vehicle.color}</p>
                                            <p><strong>Base Price:</strong> $${data.vehicle.basePrice.toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-info-circle"></i> Quotation Details</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <p><strong>Quotation ID:</strong> #Q${data.quotationId.toString().padStart(3, '0')}</p>
                                            <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(data.status)}">${data.status}</span></p>
                                            <p><strong>Created:</strong> ${data.createdAt}</p>
                                            <p><strong>Dealer:</strong> ${data.dealer.name}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success"><i class="fas fa-dollar-sign"></i> Pricing</h6>
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">Base Price:</div>
                                                <div class="col text-end">$${data.vehicle.basePrice.toLocaleString()}</div>
                                            </div>
                                            <div class="row">
                                                <div class="col">Discount:</div>
                                                <div class="col text-end text-danger">-$${(data.vehicle.basePrice - data.price).toLocaleString()}</div>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col"><strong>Final Price:</strong></div>
                                                <div class="col text-end"><strong class="text-success h5">$${data.price.toLocaleString()}</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    } else {
                        $('#quotationDetails').html(`
                            <div class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                                <div class="mt-2">${response.message}</div>
                            </div>
                        `);
                    }
                })
                .fail(function() {
                    $('#quotationDetails').html(`
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                            <div class="mt-2">Failed to load quotation details. Please try again.</div>
                        </div>
                    `);
                });
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'Pending': return 'bg-warning text-dark';
                case 'Approved': return 'bg-success';
                case 'Rejected': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function filterQuotations() {
            const status = $('#statusFilter').val().toLowerCase();
            const customerSearch = $('#customerSearch').val().toLowerCase();
            const vehicleSearch = $('#vehicleSearch').val().toLowerCase();
            
            $('tbody tr').each(function() {
                const row = $(this);
                const statusText = row.find('td:eq(5) .badge').text().toLowerCase();
                const customerText = row.find('td:eq(1)').text().toLowerCase();
                const vehicleText = row.find('td:eq(2)').text().toLowerCase();
                
                let showRow = true;
                
                // Filter by status
                if (status && !statusText.includes(status)) {
                    showRow = false;
                }
                
                // Filter by customer
                if (customerSearch && !customerText.includes(customerSearch)) {
                    showRow = false;
                }
                
                // Filter by vehicle
                if (vehicleSearch && !vehicleText.includes(vehicleSearch)) {
                    showRow = false;
                }
                
                if (showRow) {
                    row.show();
                } else {
                    row.hide();
                }
            });
            
            // Update results count
            const visibleRows = $('tbody tr:visible').length;
            const totalRows = $('tbody tr').length;
            
            if (visibleRows === 0 && (status || customerSearch || vehicleSearch)) {
                if (!$('#no-results').length) {
                    $('tbody').append('<tr id="no-results"><td colspan="7" class="text-center text-muted py-4"><i class="fas fa-search"></i> No quotations found matching your search criteria.</td></tr>');
                }
            } else {
                $('#no-results').remove();
            }
        }

        // Add real-time search
        $(document).ready(function() {
            $('#customerSearch, #vehicleSearch').on('input', function() {
                filterQuotations();
            });
        });

        function showSuccess(message) {
            // You can implement toast notifications here
            alert(message);
        }

        function showError(message) {
            // You can implement toast notifications here
            alert(message);
        }
    </script>
}